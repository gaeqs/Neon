#version 460
#extension GL_EXT_mesh_shader: enable

const int PRIMITIVES = 32;

layout (local_size_x = 1, local_size_y = 1, local_size_z = 1) in;
layout (triangles) out;
layout (max_vertices = PRIMITIVES * 3, max_primitives = PRIMITIVES) out;

layout (set = 0, binding = 0) uniform Matrices
{
    mat4 view;
    mat4 viewProjection;
    mat4 inverseProjection;
    float near;
    float far;
};

layout(std430, set = 2, binding = 0) buffer Data {
    vec4 vertices[];
};

layout(set = 2, binding = 1) uniform Properties {
    int verticesAmount;
};

void main()
{

    uint start = gl_WorkGroupID.x * PRIMITIVES * 3;
    uint end = min(start + PRIMITIVES, verticesAmount);

    uint verticesToProcess = end - start;
    uint primitivesToProcess = verticesToProcess / 3;

    SetMeshOutputsEXT(verticesToProcess, primitivesToProcess);

    for (int i = 0; i < verticesToProcess; ++i) {
        gl_MeshVerticesEXT[i].gl_Position = viewProjection * vertices[start + i];
    }

    int n = 0;
    for (int i = 0; i < primitivesToProcess; ++i) {
        gl_PrimitiveTriangleIndicesEXT[i] = uvec3(n, n + 1, n + 2);
        n += 3;
    }
}
    